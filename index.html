<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CastNet ‚Äì Fly Fishing Patagonia</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="language-switch">
    <button id="lang-es" class="active">ES</button>
    <button id="lang-en">EN</button>
  </div>
  <div class="hero">
    <header class="navbar">
      <img src="assets/hook-icon.png" alt="CastNet Logo" class="logo" />
      <div class="user-profile">
        <a href="#" id="user-icon" class="user-button hidden"></a>
        <div class="profile-dropdown" id="profile-dropdown">
          <a href="#profile" data-i18n="profile.myProfile">Mi Perfil</a>
          <a href="#settings" data-i18n="profile.settings">Ajustes de Perfil</a>
          <a href="#" id="btn-publish-trip" data-i18n="profile.publishTrip">Publica Salida de Pesca</a>
          <a href="#search" data-i18n="profile.searchTrip">Buscar Salida de Pesca</a>
          <a href="#" id="logout" data-i18n="profile.logout">Cerrar Sesi√≥n</a>
        </div>
      </div>
      <nav>
        <a href="#" data-i18n="nav.trips">Salidas</a>
        <a href="#" data-i18n="nav.anglers">Pescadores</a>
        <a href="#" data-i18n="nav.guides">Gu√≠as</a>
        <a href="#packages" data-i18n="nav.packages">Paquetes Completos</a>
        <a href="#" id="btn-open-login" data-i18n="nav.login">Ingresar</a>
        <a href="#" id="btn-open-register" data-i18n="nav.register">Registrarse</a>
      </nav>
    </header>

    <main class="content">
      <h1 class="title" data-i18n="hero.title">CastNet</h1>
      <p class="subtitle small" data-i18n="hero.subtitle1">Conect√° con pescadores y gu√≠as, compart√≠ flotadas y conoc√© nuevos r√≠os y lagos.</p>
      <p class="subtitle small" data-i18n="hero.subtitle2">Caste√° en red.</p>

      <button id="btn-open-search" class="main-cta-button" data-i18n="hero.planButton">Plan your next Cast</button>

      <h2 class="section-heading" data-i18n="sections.recommended">Opciones recomendadas para ti</h2>
      <section class="cards recommended-cards">
        <div class="card">
          <div class="card-icon">
            <img src="assets/lancha.png" alt="Lancha Icon" style="width: 28px; height: 28px;" />
          </div>
          <div class="info">
            <h3>Mar 12 ‚Äì 14</h3>
            <p>Paim√∫n, Lancha Compartida (3 lugares)</p>
          </div>
        </div>

        <div class="card">
          <div class="card-icon">
            <img src="assets/mackenzie.png" alt="Mackenzie Boat Icon" style="width: 28px; height: 28px;" />
          </div>
          <div class="info">
            <h3>Apr 5 ‚Äì 6</h3>
            <p>Catarraft + Balsa: Chimehuin arriba (2 lugares)</p>
          </div>
        </div>

        <div class="card">
          <div class="card-icon">
            <img src="assets/vadeo.png" alt="Vadeo Icon" style="width: 28px; height: 28px;" />
          </div>
          <div class="info">
            <h3>May 19 ‚Äì 22</h3>
            <p>Coll√≥n Cura, vadeo</p>
          </div>
        </div>
      </section>

      <h2 class="section-heading" data-i18n="sections.published">Salidas Publicadas</h2>
      <section class="cards user-trips-cards"></section>
    </main>
  </div>

  <section class="packages-section" id="packages">
    <h2 class="section-heading" data-i18n="sections.packages">Paquetes Completos de Fly Fishing</h2>

    <div class="country-filters">
      <button class="country-filter-btn active" data-country="all" data-i18n="packages.allCountries">Todos los Pa√≠ses</button>
      <button class="country-filter-btn" data-country="Argentina" data-i18n="packages.argentina">Argentina</button>
      <button class="country-filter-btn" data-country="Chile" data-i18n="packages.chile">Chile</button>
    </div>

    <div class="packages-grid" id="packages-grid"></div>
  </section>

  <div class="hero">
    <main class="content">
      <h2 class="section-heading" data-i18n="sections.testimonials">Testimonios</h2>
      <section class="testimonials">
        <div class="testimonial">
          <img src="assets/Luca.png" alt="Luca">
          <blockquote>"Con CastNet me sum√© a una flotada en Catarraft por el Chimehuin arriba (saliendo de Huechulafquen) con locales de Jun√≠n de los Andes. Mejor experiencia imposible."</blockquote>
          <p class="author">Luca, Torino</p>
        </div>

        <div class="testimonial">
          <img src="assets/Clemence.png" alt="Cl√©mence">
          <blockquote>"Lo mejor de CastNet es la conexi√≥n humana. Enfermos de la pesca ahora nos econtramos mas rapido"</blockquote>
          <p class="author">Cl√©mence, Francia</p>
        </div>

        <div class="testimonial">
          <img src="assets/Tom.png" alt="Tom">
          <blockquote>"Reserv√© una flotada en el r√≠o Malleo con un gu√≠a, y a ultimo momento mis amigos no pudieron venir. Por suerte con CastNet consegui dos tremendos pescadores (ahora amigos) que mejoraron por mucho la experiencia."</blockquote>
          <p class="author">Tom, EE.UU.</p>
        </div>
      </section>

      <div id="auth-modal" class="modal hidden">
        <div class="modal-content">
          <span class="close-btn" id="close-modal">&times;</span>
          <h2 id="modal-title">Autenticaci√≥n</h2>
          <form id="auth-form">
            <input type="text" id="first-name" data-i18n-placeholder="modal.firstName" placeholder="Nombre" class="hidden" />
            <input type="text" id="last-name" data-i18n-placeholder="modal.lastName" placeholder="Apellido" class="hidden" />
            <input type="email" id="email" data-i18n-placeholder="modal.email" placeholder="Email" required />
            <input type="password" id="password" data-i18n-placeholder="modal.password" placeholder="Contrase√±a" required />
            <input type="password" id="confirm-password" data-i18n-placeholder="modal.confirmPassword" placeholder="Confirmar Contrase√±a" class="hidden" />
            <button type="submit" id="btn-auth-action">Ingresar</button>
          </form>
          <div id="social-logins" class="social-buttons">
            <button id="btn-google" class="social-button">
              <img src="assets/google-logo.png" alt="Google logo" />
              <span data-i18n="modal.continueGoogle">Continuar con Google</span>
            </button>
            <button id="btn-facebook" class="social-button">
              <img src="assets/facebook-logo.png" alt="Facebook logo" />
              <span data-i18n="modal.continueFacebook">Continuar con Facebook</span>
            </button>
          </div>
          <p id="auth-message"></p>
        </div>
      </div>

      <div id="publish-trip-modal" class="modal hidden">
        <div class="modal-content">
          <span class="close-btn" id="close-publish-modal">&times;</span>
          <h2 data-i18n="publishTrip.title">Publicar Salida de Pesca</h2>
          <form id="publish-trip-form">
            <input type="text" id="trip-location" data-i18n-placeholder="publishTrip.location" placeholder="Ubicaci√≥n" required />
            <input type="date" id="trip-start-date" data-i18n-placeholder="publishTrip.startDate" placeholder="D√≠a de comienzo" required />
            <input type="date" id="trip-end-date" data-i18n-placeholder="publishTrip.endDate" placeholder="D√≠a de finalizaci√≥n" required />
            <input type="time" id="trip-start-time" data-i18n-placeholder="publishTrip.startTime" placeholder="Horario de salida" required />
            <input type="time" id="trip-end-time" data-i18n-placeholder="publishTrip.endTime" placeholder="Horario de finalizaci√≥n" required />

            <div class="form-group">
              <label data-i18n="publishTrip.activity">Actividad:</label>
              <div class="radio-group">
                <label>
                  <input type="radio" name="activity" value="vadeo" required> <span data-i18n="publishTrip.vadeo">Vadeo</span>
                </label>
                <label>
                  <input type="radio" name="activity" value="deriva"> <span data-i18n="publishTrip.deriva">Deriva: Bote/Balsa/Catarraft</span>
                </label>
                <label>
                  <input type="radio" name="activity" value="lancha"> <span data-i18n="publishTrip.lancha">Lancha</span>
                </label>
                <label>
                  <input type="radio" name="activity" value="otro"> <span data-i18n="publishTrip.otro">Otro</span>
                </label>
              </div>
              <input type="text" id="activity-other" data-i18n-placeholder="publishTrip.otherActivity" placeholder="Especificar otra actividad" class="hidden" />
            </div>

            <div class="form-group">
              <label for="available-spots" data-i18n="publishTrip.availableSpots">Lugares disponibles:</label>
              <input type="number" id="available-spots" min="1" value="1" required />
            </div>

            <button type="submit" class="cta-button" data-i18n="publishTrip.publish">Publicar Salida</button>
          </form>
        </div>
      </div>

      <div id="search-modal" class="modal hidden">
        <div class="modal-content">
          <span class="close-btn" id="close-search-modal">&times;</span>
          <h2 data-i18n="searchModal.title">Buscar Salida de Pesca</h2>
          <form id="search-form">
            <input type="text" id="search-location" data-i18n-placeholder="searchModal.location" placeholder="Ubicaci√≥n" required />
            <input type="date" id="search-start-date" data-i18n-placeholder="searchModal.startDate" placeholder="Fecha de inicio" required />
            <input type="date" id="search-end-date" data-i18n-placeholder="searchModal.endDate" placeholder="Fecha de fin" required />
            <input type="time" id="search-start-time" data-i18n-placeholder="searchModal.startTime" placeholder="Hora de inicio" required />
            <input type="time" id="search-end-time" data-i18n-placeholder="searchModal.endTime" placeholder="Hora de fin" required />
            <button type="submit" class="cta-button" data-i18n="searchModal.search">Buscar</button>
          </form>
        </div>
      </div>

    </main>
  </div>

  <footer>
    <p data-i18n="footer.copyright">¬© 2025 CastNet. Hecho en Patagonia. Todos los derechos reservados.</p>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script type="module">
    import { translations, getTranslation } from './src/translations.js';
    import { supabase } from './src/supabaseClient.js';
    
    const firebaseConfig = {
      apiKey: "AIzaSyB-jb3mybgixNPt4DbjveAamPLXPjfdUnw",
      authDomain: "castnet-8a81c.firebaseapp.com",
      projectId: "castnet-8a81c",
      storageBucket: "castnet-8a81c.firebasestorage.app",
      messagingSenderId: "685260060310",
      appId: "1:685260060310:web:e82e1193ec898d489474b7"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const providerGoogle = new firebase.auth.GoogleAuthProvider();
    const providerFacebook = new firebase.auth.FacebookAuthProvider();

    const modal = document.getElementById('auth-modal');
    const publishTripModal = document.getElementById('publish-trip-modal');
    const searchModal = document.getElementById('search-modal');
    const modalTitle = document.getElementById('modal-title');
    const btnAuthAction = document.getElementById('btn-auth-action');
    const closeModalBtn = document.getElementById('close-modal');
    const closePublishModalBtn = document.getElementById('close-publish-modal');
    const closeSearchModalBtn = document.getElementById('close-search-modal');
    const authForm = document.getElementById('auth-form');
    const publishTripForm = document.getElementById('publish-trip-form');
    const searchForm = document.getElementById('search-form');
    const authMessage = document.getElementById('auth-message');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    const firstNameInput = document.getElementById('first-name');
    const lastNameInput = document.getElementById('last-name');
    const socialLogins = document.getElementById('social-logins');
    const loginBtn = document.getElementById('btn-open-login');
    const registerBtn = document.getElementById('btn-open-register');
    const btnOpenSearch = document.getElementById('btn-open-search');
    const userIcon = document.getElementById('user-icon');
    const profileDropdown = document.getElementById('profile-dropdown');
    const logoutBtn = document.getElementById('logout');
    const btnPublishTrip = document.getElementById('btn-publish-trip');
    const activityOtherInput = document.getElementById('activity-other');

    let isLogin = true;
    let currentLang = 'es';
    let currentCountryFilter = 'all';

    function updateLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;

      document.querySelectorAll('[data-i18n]').forEach(elem => {
        const key = elem.getAttribute('data-i18n');
        elem.textContent = getTranslation(lang, key);
      });

      document.querySelectorAll('[data-i18n-placeholder]').forEach(elem => {
        const key = elem.getAttribute('data-i18n-placeholder');
        elem.placeholder = getTranslation(lang, key);
      });

      document.querySelectorAll('.language-switch button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`lang-${lang}`).classList.add('active');

      loadCompletePackages();
    }

    document.getElementById('lang-es').addEventListener('click', () => updateLanguage('es'));
    document.getElementById('lang-en').addEventListener('click', () => updateLanguage('en'));

    async function loadCompletePackages() {
      try {
        let query = supabase
          .from('complete_packages')
          .select('*')
          .order('price_usd', { ascending: true });

        if (currentCountryFilter !== 'all') {
          query = query.eq('country', currentCountryFilter);
        }

        const { data: packages, error } = await query;

        if (error) throw error;

        const packagesGrid = document.getElementById('packages-grid');
        packagesGrid.innerHTML = packages.map(pkg => {
          const includes = [];
          if (pkg.includes_accommodation) includes.push(getTranslation(currentLang, 'packages.accommodation'));
          if (pkg.includes_guide) includes.push(getTranslation(currentLang, 'packages.guide'));
          if (pkg.includes_fishing) includes.push(getTranslation(currentLang, 'packages.fishing'));
          if (pkg.includes_meals) includes.push(getTranslation(currentLang, 'packages.meals'));
          if (pkg.includes_transport) includes.push(getTranslation(currentLang, 'packages.transport'));

          const description = currentLang === 'es' ? pkg.description_es : pkg.description_en;
          const difficultyLabel = getTranslation(currentLang, `packages.${pkg.difficulty_level}`);

          return `
            <div class="package-card">
              <div class="package-card-content">
                <h3>${pkg.package_name}</h3>
                <div class="package-meta">
                  <span>üìç ${pkg.location}</span>
                  <span>‚è±Ô∏è ${pkg.duration_days} ${getTranslation(currentLang, 'packages.days')}</span>
                  <span>üë• ${pkg.max_guests} ${getTranslation(currentLang, 'packages.guests')}</span>
                </div>
                <p class="package-description">${description}</p>
                <div class="package-includes">
                  ${includes.map(inc => `<span>${inc}</span>`).join('')}
                </div>
                <p class="package-price">USD $${pkg.price_usd.toLocaleString()}</p>
                <div class="package-meta">
                  <span>${getTranslation(currentLang, 'packages.season')}: ${pkg.season_start} - ${pkg.season_end}</span>
                </div>
                <div class="package-meta">
                  <span>${getTranslation(currentLang, 'packages.difficulty')}: ${difficultyLabel}</span>
                </div>
                <p class="package-species">${getTranslation(currentLang, 'packages.species')}: ${pkg.target_species.join(', ')}</p>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading packages:', error);
      }
    }

    document.querySelectorAll('.country-filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        currentCountryFilter = this.getAttribute('data-country');
        document.querySelectorAll('.country-filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        loadCompletePackages();
      });
    });

    loadCompletePackages();

    btnPublishTrip.addEventListener('click', (e) => {
      e.preventDefault();
      profileDropdown.classList.remove('active');
      publishTripModal.classList.remove('hidden');
    });

    closePublishModalBtn.addEventListener('click', () => {
      publishTripModal.classList.add('hidden');
      publishTripForm.reset();
    });

    btnOpenSearch.addEventListener('click', () => {
      searchModal.classList.remove('hidden');
    });

    closeSearchModalBtn.addEventListener('click', () => {
      searchModal.classList.add('hidden');
      searchForm.reset();
    });

    searchForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const searchData = {
        location: document.getElementById('search-location').value,
        startDate: document.getElementById('search-start-date').value,
        endDate: document.getElementById('search-end-date').value,
        startTime: document.getElementById('search-start-time').value,
        endTime: document.getElementById('search-end-time').value
      };
      console.log('Searching with:', searchData);
      searchModal.classList.add('hidden');
      searchForm.reset();
    });

    document.querySelectorAll('input[name="activity"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        if (e.target.value === 'otro') {
          activityOtherInput.classList.remove('hidden');
          activityOtherInput.required = true;
        } else {
          activityOtherInput.classList.add('hidden');
          activityOtherInput.required = false;
        }
      });
    });

    publishTripForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      try {
        const formData = {
          location: document.getElementById('trip-location').value,
          start_date: document.getElementById('trip-start-date').value,
          end_date: document.getElementById('trip-end-date').value,
          start_time: document.getElementById('trip-start-time').value,
          end_time: document.getElementById('trip-end-time').value,
          activity_type: document.querySelector('input[name="activity"]:checked').value,
          activity_other: document.getElementById('activity-other').value,
          available_spots: parseInt(document.getElementById('available-spots').value),
          user_id: auth.currentUser.uid
        };

        const { data, error } = await supabase
          .from('fishing_trips')
          .insert([formData]);

        if (error) throw error;

        alert('Salida de pesca publicada exitosamente!');
        publishTripModal.classList.add('hidden');
        publishTripForm.reset();
        
        loadFishingTrips();
      } catch (error) {
        alert('Error al publicar la salida: ' + error.message);
      }
    });

    async function loadFishingTrips() {
      try {
        const { data: trips, error } = await supabase
          .from('fishing_trips')
          .select('*')
          .order('start_date', { ascending: true });

        if (error) throw error;

        const userTripsContainer = document.querySelector('.user-trips-cards');
        userTripsContainer.innerHTML = trips.map(trip => `
          <div class="card">
            <div class="card-icon">
              <img src="assets/${trip.activity_type === 'vadeo' ? 'vadeo.png' : 
                              trip.activity_type === 'deriva' ? 'mackenzie.png' : 
                              trip.activity_type === 'lancha' ? 'lancha.png' : 'vadeo.png'}" 
                   alt="${trip.activity_type}" style="width: 28px; height: 28px;" />
            </div>
            <div class="info">
              <h3>${new Date(trip.start_date).toLocaleDateString()} ‚Äì ${new Date(trip.end_date).toLocaleDateString()}</h3>
              <p>${trip.location}, ${trip.activity_type === 'otro' ? trip.activity_other : trip.activity_type} 
                 (${trip.available_spots} lugares)</p>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading trips:', error);
      }
    }

    loadFishingTrips();

    userIcon.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      profileDropdown.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
      if (!profileDropdown.contains(e.target) && !userIcon.contains(e.target)) {
        profileDropdown.classList.remove('active');
      }
    });

    logoutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      auth.signOut();
      profileDropdown.classList.remove('active');
    });

    loginBtn.addEventListener('click', (e) => {
      e.preventDefault();
      isLogin = true;
      modalTitle.textContent = 'Ingresar';
      btnAuthAction.textContent = 'Ingresar';
      socialLogins.style.display = 'flex';
      firstNameInput.classList.add('hidden');
      lastNameInput.classList.add('hidden');
      confirmPasswordInput.classList.add('hidden');
      modal.classList.remove('hidden');
    });

    registerBtn.addEventListener('click', (e) => {
      e.preventDefault();
      isLogin = false;
      modalTitle.textContent = 'Registrarse';
      btnAuthAction.textContent = 'Registrarse';
      socialLogins.style.display = 'none';
      firstNameInput.classList.remove('hidden');
      lastNameInput.classList.remove('hidden');
      confirmPasswordInput.classList.remove('hidden');
      modal.classList.remove('hidden');
    });

    closeModalBtn.addEventListener('click', () => {
      modal.classList.add('hidden');
      authForm.reset();
      authMessage.textContent = '';
    });

    authForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = emailInput.value;
      const password = passwordInput.value;
      const confirmPassword = confirmPasswordInput.value;
      authMessage.textContent = '';

      try {
        if (isLogin) {
          await auth.signInWithEmailAndPassword(email, password);
          authMessage.style.color = 'green';
          authMessage.textContent = 'Ingreso exitoso. ¬°Bienvenido!';
        } else {
          if (password !== confirmPassword) {
            throw new Error("Las contrase√±as no coinciden.");
          }
          await auth.createUserWithEmailAndPassword(email, password);
          authMessage.style.color = 'green';
          authMessage.textContent = 'Usuario registrado exitosamente.';
        }
      } catch (error) {
        authMessage.style.color = 'red';
        authMessage.textContent = 'Error: ' + error.message;
      }
    });

    document.getElementById('btn-google').addEventListener('click', async () => {
      try {
        await auth.signInWithPopup(providerGoogle);
        authMessage.style.color = 'green';
        authMessage.textContent = 'Ingreso exitoso con Google.';
        modal.classList.add('hidden');
      } catch (error) {
        authMessage.style.color = 'red';
        authMessage.textContent = 'Error: ' + error.message;
      }
    });

    document.getElementById('btn-facebook').addEventListener('click', async () => {
      try {
        await auth.signInWithPopup(providerFacebook);
        authMessage.style.color = 'green';
        authMessage.textContent = 'Ingreso exitoso con Facebook.';
        modal.classList.add('hidden');
      } catch (error) {
        authMessage.style.color = 'red';
        authMessage.textContent = 'Error: ' + error.message;
      }
    });

    auth.onAuthStateChanged(user => {
      if (user) {
        console.log('Usuario logueado:', user.email);
        modal.classList.add('hidden');
        authForm.reset();

        const displayName = user.displayName || user.email;
        const initials = displayName
          .split(' ')
          .map(word => word[0])
          .join('')
          .slice(0, 2)
          .toUpperCase();

        userIcon.textContent = initials;
        userIcon.classList.remove('hidden');
        loginBtn.classList.add('hidden');
        registerBtn.classList.add('hidden');
      } else {
        userIcon.classList.add('hidden');
        loginBtn.classList.remove('hidden');
        registerBtn.classList.remove('hidden');
        profileDropdown.classList.remove('active');
      }
    });
  </script>
</body>
</html>